
<!DOCTYPE html>

<html>
<head>
    <title>refine_linearrefinegt.go</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="gocco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <div id="jump_to">
        Jump To &hellip;
        <div id="jump_wrapper">
          <div id="jump_page">
              
              <a class="source" href="core_binaryreconcile.html">
                  core_binaryreconcile.go
              </a>
              
              <a class="source" href="core_genetree.html">
                  core_genetree.go
              </a>
              
              <a class="source" href="core_node.html">
                  core_node.go
              </a>
              
              <a class="source" href="core_rf.html">
                  core_rf.go
              </a>
              
              <a class="source" href="core_speciestree.html">
                  core_speciestree.go
              </a>
              
              <a class="source" href="core_test.html">
                  core_test.go
              </a>
              
              <a class="source" href="core_tree.html">
                  core_tree.go
              </a>
              
              <a class="source" href="refine_linearrefinegt.html">
                  refine_linearrefinegt.go
              </a>
              
              <a class="source" href="refine_test.html">
                  refine_test.go
              </a>
              
              <a class="source" href="util_contract.html">
                  util_contract.go
              </a>
              
              <a class="source" href="util_prune.html">
                  util_prune.go
              </a>
              
              <a class="source" href="util_simu.html">
                  util_simu.go
              </a>
              
              <a class="source" href="util_test.html">
                  util_test.go
              </a>
              
          </div>
        </div>
      </div>
    
    <table cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th class="docs">
            <h1>
                refine_linearrefinegt.go
            </h1>
          </th>
          <th class="code">
          </th>
        </tr>
      </thead>
      <tbody>
          
          <tr id="section-1">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
                
            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kn">package</span> <span class="nx">tree</span>

<span class="kn">import</span> <span class="p">(</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-2">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
                <p>. &ldquo;txtgo/tree&rdquo;</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="s">&quot;errors&quot;</span>
    <span class="s">&quot;sort&quot;</span>
<span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-3">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
                <p>A dispatch function</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">func</span> <span class="nx">RefineGt</span><span class="p">(</span><span class="nx">gt</span> <span class="o">*</span><span class="nx">Tree</span><span class="p">,</span> <span class="nx">st</span> <span class="o">*</span><span class="nx">SpeciesTree</span><span class="p">,</span> <span class="nx">method</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">weights</span> <span class="o">...</span><span class="kt">float64</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-4">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
                <p>refine := minDupPlusLoss</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">refine</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Node</span><span class="p">)</span>
	<span class="k">switch</span> <span class="nx">method</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span><span class="p">:</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-5">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
                <p>println(&ldquo;dl&rdquo;)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="nx">refine</span> <span class="p">=</span> <span class="nx">minDupThenLoss</span>
	<span class="k">case</span> <span class="mi">1</span><span class="p">:</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-6">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
                <p>println(&ldquo;mu&rdquo;)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="nx">refine</span> <span class="p">=</span> <span class="nx">minDupPlusLoss</span>
	<span class="k">case</span> <span class="mi">2</span><span class="p">:</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-7">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
                <p>println(&ldquo;ld&rdquo;)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="nx">refine</span> <span class="p">=</span> <span class="nx">minLossThenDup</span>
	<span class="k">case</span> <span class="mi">3</span><span class="p">:</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-8">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
                <p>println(&ldquo;weight&rdquo;)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="nx">refine</span> <span class="p">=</span> <span class="nx">weightedCost</span><span class="p">(</span><span class="nx">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
	<span class="k">default</span><span class="p">:</span>
		<span class="nb">panic</span><span class="p">(</span><span class="s">&quot;Wrong method&quot;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">linearRefineGt</span><span class="p">(</span><span class="nx">gt</span><span class="p">,</span> <span class="nx">st</span><span class="p">,</span> <span class="nx">refine</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">linearRefineGt</span><span class="p">(</span><span class="nx">gt</span> <span class="o">*</span><span class="nx">Tree</span><span class="p">,</span> <span class="nx">st</span> <span class="o">*</span><span class="nx">SpeciesTree</span><span class="p">,</span> <span class="nx">refine</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Node</span><span class="p">))</span> <span class="p">([][]</span><span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">st</span><span class="p">.</span><span class="nx">IsBinary</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;Species tree is not binary.&quot;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">gt</span><span class="p">.</span><span class="nx">IsBinary</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="p">}</span>

	<span class="nx">sl</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nx">Nodes</span>
	<span class="nx">gl</span> <span class="o">:=</span> <span class="nx">gt</span><span class="p">.</span><span class="nx">Nodes</span>

	<span class="nx">lm</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">LcaMap</span><span class="p">(</span><span class="nx">gt</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>
	<span class="nx">lca</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nx">Lca</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">M</span> <span class="o">:=</span> <span class="nx">lm</span><span class="p">.</span><span class="nx">Map</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-9">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
                <hr />

<p>1) find the pre-image pre[s] of every species
node s under LCA mapping.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">pre</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([][]</span><span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">sl</span><span class="p">))</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-10">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
                <p>d[node.Id]: index of node in node.Father.Children</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">d</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">gl</span><span class="p">))</span>
	<span class="kd">var</span> <span class="nx">sid</span> <span class="kt">int</span>
	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">gn</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">gl</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">gn</span><span class="p">.</span><span class="nx">IsInternal</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">for</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">gn</span><span class="p">.</span><span class="nx">Children</span> <span class="p">{</span>
				<span class="nx">d</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">Id</span><span class="p">]</span> <span class="p">=</span> <span class="nx">j</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="nx">sid</span> <span class="p">=</span> <span class="nx">M</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Id</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-11">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
                <p>println(&rdquo;: &ldquo;, gn.Name, &ldquo;-&gt;&rdquo;, M[i].Name)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="nx">pre</span><span class="p">[</span><span class="nx">sid</span><span class="p">]</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">pre</span><span class="p">[</span><span class="nx">sid</span><span class="p">],</span> <span class="nx">gn</span><span class="p">)</span>
	<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-12">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
                <hr />

<p>2) reorder the children of every non-binary
gene tree node swap the children i and j</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">swap</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">children</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
		<span class="nx">d</span><span class="p">[</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Id</span><span class="p">]</span> <span class="p">=</span> <span class="nx">i</span>
		<span class="nx">d</span><span class="p">[</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">Id</span><span class="p">]</span> <span class="p">=</span> <span class="nx">j</span>
	<span class="p">}</span>

	<span class="nx">ind</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">gl</span><span class="p">))</span>
	<span class="kd">var</span> <span class="nx">fn</span> <span class="o">*</span><span class="nx">Node</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sn</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">sl</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">gn</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pre</span><span class="p">[</span><span class="nx">sn</span><span class="p">.</span><span class="nx">Id</span><span class="p">]</span> <span class="p">{</span>
			<span class="nx">fn</span> <span class="p">=</span> <span class="nx">gn</span><span class="p">.</span><span class="nx">Father</span>
			<span class="k">if</span> <span class="nx">fn</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">break</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">!</span><span class="nx">fn</span><span class="p">.</span><span class="nx">IsBinary</span><span class="p">()</span> <span class="p">{</span>
				<span class="nx">swap</span><span class="p">(</span><span class="nx">fn</span><span class="p">.</span><span class="nx">Children</span><span class="p">,</span> <span class="nx">ind</span><span class="p">[</span><span class="nx">fn</span><span class="p">.</span><span class="nx">Id</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="nx">gn</span><span class="p">.</span><span class="nx">Id</span><span class="p">])</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-13">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
                <p>fmt.Println(&ldquo;put&rdquo;, gn.Name, ind[fn.Id])</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>				<span class="nx">ind</span><span class="p">[</span><span class="nx">fn</span><span class="p">.</span><span class="nx">Id</span><span class="p">]</span><span class="o">++</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-14">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
                <p>fmt.Println(gt)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre></pre></div>
            </td>
          </tr>
          
          <tr id="section-15">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
                <hr />

<p>3) for every non-binary gene tree node g
find every node s in I^*(g), make a copy s&rsquo; of s,
and set s&rsquo;.Father = g.
If g_i maps to s, then append g_i to s&rsquo;.Ext.<br />
Finally, append s&rsquo; to b<a href="b[s.Id] in fact">s</a>.
Notice that we just use s&rsquo;.Father to store g.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">makeCopy</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="o">*</span><span class="nx">Node</span> <span class="p">{</span>
		<span class="nx">n</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Node</span><span class="p">{</span><span class="o">&amp;</span><span class="nx">data</span><span class="p">{},</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">}</span>
		<span class="nx">n</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Name</span>
		<span class="nx">n</span><span class="p">.</span><span class="nx">Level</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Level</span>
		<span class="k">return</span> <span class="nx">n</span>
	<span class="p">}</span>

	<span class="nx">appendCopy</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">l</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">leaf</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Node</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">l</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">Father</span> <span class="o">!=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Father</span> <span class="p">{</span>
			<span class="nx">n</span> <span class="o">:=</span> <span class="nx">makeCopy</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
			<span class="nx">n</span><span class="p">.</span><span class="nx">Father</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Father</span>
			<span class="nx">l</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">leaf</span> <span class="p">{</span>
			<span class="nx">n</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Ext</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">n</span><span class="p">.</span><span class="nx">Ext</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">Ext</span><span class="p">.([]</span><span class="o">*</span><span class="nx">Node</span><span class="p">),</span> <span class="nx">c</span><span class="p">)</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">n</span><span class="p">.</span><span class="nx">Ext</span> <span class="p">=</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Node</span><span class="p">{</span><span class="nx">c</span><span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">l</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">Father</span> <span class="o">!=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Father</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Father</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nb">panic</span><span class="p">(</span><span class="s">&quot;What!&quot;</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">l</span>
	<span class="p">}</span>

	<span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([][]</span><span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">sl</span><span class="p">))</span>
	<span class="kd">var</span> <span class="nx">tn</span> <span class="o">*</span><span class="nx">Node</span>
	<span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">tid</span> <span class="kt">int</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">gn</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">gl</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">!</span><span class="nx">gn</span><span class="p">.</span><span class="nx">IsBinary</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">gn</span><span class="p">.</span><span class="nx">IsLeaf</span><span class="p">()</span> <span class="p">{</span>

			<span class="k">for</span> <span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">gn</span><span class="p">.</span><span class="nx">Children</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
				<span class="nx">tn</span> <span class="p">=</span> <span class="nx">M</span><span class="p">[</span><span class="nx">gn</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Id</span><span class="p">]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-16">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
                <p>println(&ldquo;&gt;&gt; &ldquo;, gn.Children[i].Name, tn.Name)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>				<span class="nx">tid</span> <span class="p">=</span> <span class="nx">tn</span><span class="p">.</span><span class="nx">Id</span>
				<span class="nx">b</span><span class="p">[</span><span class="nx">tid</span><span class="p">]</span> <span class="p">=</span> <span class="nx">appendCopy</span><span class="p">(</span><span class="nx">tn</span><span class="p">,</span> <span class="nx">b</span><span class="p">[</span><span class="nx">tid</span><span class="p">],</span> <span class="nx">gn</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kc">true</span><span class="p">)</span>
				<span class="nx">tn</span> <span class="p">=</span> <span class="nx">lca</span><span class="p">(</span><span class="nx">tn</span><span class="p">,</span> <span class="nx">M</span><span class="p">[</span><span class="nx">gn</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="nx">Id</span><span class="p">])</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-17">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
                <p>println(&ldquo;&gt;&gt; &ldquo;, gn.Children[i].Name, gn.Children[i+1].Name, tn.Name)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>				<span class="nx">tid</span> <span class="p">=</span> <span class="nx">tn</span><span class="p">.</span><span class="nx">Id</span>
				<span class="nx">b</span><span class="p">[</span><span class="nx">tid</span><span class="p">]</span> <span class="p">=</span> <span class="nx">appendCopy</span><span class="p">(</span><span class="nx">tn</span><span class="p">,</span> <span class="nx">b</span><span class="p">[</span><span class="nx">tid</span><span class="p">],</span> <span class="nx">gn</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kc">false</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="nx">tn</span> <span class="p">=</span> <span class="nx">M</span><span class="p">[</span><span class="nx">gn</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Id</span><span class="p">]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-18">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
                <p>println(&ldquo;&gt;&gt; &ldquo;, gn.Children[i].Name, tn.Name)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>			<span class="nx">tid</span> <span class="p">=</span> <span class="nx">tn</span><span class="p">.</span><span class="nx">Id</span>
			<span class="nx">b</span><span class="p">[</span><span class="nx">tid</span><span class="p">]</span> <span class="p">=</span> <span class="nx">appendCopy</span><span class="p">(</span><span class="nx">tn</span><span class="p">,</span> <span class="nx">b</span><span class="p">[</span><span class="nx">tid</span><span class="p">],</span> <span class="nx">gn</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kc">true</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-19">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
                <p>println(&ldquo;Step 3 done.&rdquo;)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre></pre></div>
            </td>
          </tr>
          
          <tr id="section-20">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
                <p>4) Using Euler Tour of species tree to find
the corresponding Euler Tour a<a href="a[g.Id] in fact">g</a>
of every I^*(g).</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">visit</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">bool</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">sl</span><span class="p">))</span>
	<span class="nx">a</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([][]</span><span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">gl</span><span class="p">))</span>
	<span class="kd">var</span> <span class="nx">gn</span><span class="p">,</span> <span class="nx">sn</span> <span class="o">*</span><span class="nx">Node</span>
	<span class="nx">tn</span> <span class="p">=</span> <span class="nx">st</span><span class="p">.</span><span class="nx">Node</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">tid</span> <span class="p">=</span> <span class="nx">tn</span><span class="p">.</span><span class="nx">Id</span>
		<span class="nx">visit</span><span class="p">[</span><span class="nx">tid</span><span class="p">]</span> <span class="p">=</span> <span class="kc">true</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sn</span> <span class="p">=</span> <span class="k">range</span> <span class="nx">b</span><span class="p">[</span><span class="nx">tid</span><span class="p">]</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-21">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
                <p>In step 3), we use sn.Father = g
to indicates that sn is in the tree I^*(g).</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>			<span class="nx">gn</span> <span class="p">=</span> <span class="nx">sn</span><span class="p">.</span><span class="nx">Father</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-22">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
                <p>fmt.Println(sn.Name, &ldquo;-&gt;&rdquo;, gn)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>			<span class="nx">a</span><span class="p">[</span><span class="nx">gn</span><span class="p">.</span><span class="nx">Id</span><span class="p">]</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">gn</span><span class="p">.</span><span class="nx">Id</span><span class="p">],</span> <span class="nx">sn</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">tn</span><span class="p">.</span><span class="nx">IsLeaf</span><span class="p">():</span>
			<span class="nx">tn</span> <span class="p">=</span> <span class="nx">tn</span><span class="p">.</span><span class="nx">Father</span>
		<span class="k">case</span> <span class="p">!</span><span class="nx">visit</span><span class="p">[</span><span class="nx">tn</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Id</span><span class="p">]:</span>
			<span class="nx">tn</span> <span class="p">=</span> <span class="nx">tn</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">case</span> <span class="p">!</span><span class="nx">visit</span><span class="p">[</span><span class="nx">tn</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">Id</span><span class="p">]:</span>
			<span class="nx">tn</span> <span class="p">=</span> <span class="nx">tn</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="nx">tn</span> <span class="p">=</span> <span class="nx">tn</span><span class="p">.</span><span class="nx">Father</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">tn</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">break</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-23">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
                <p>println(&ldquo;Step 4 done.&rdquo;)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre></pre></div>
            </td>
          </tr>
          
          <tr id="section-24">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
                <p>5) Finally, reconstruct I^*(g) using its Euler Tour
a<a href="a[g.Id]">g</a>. Notice that I^*(g) is just the
reconstructed tree with root a[g]<a href="a[g.Id][0]">0</a>.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre></pre></div>
            </td>
          </tr>
          
          <tr id="section-25">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
                <p>use Eulor Tour to reconstruct the sub-tree</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">reconstruct</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">l</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">addchild</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">n</span> <span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">Children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">Children</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">n</span> <span class="p">{</span>
				<span class="nx">f</span><span class="p">.</span><span class="nx">AddChild</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="o">*</span><span class="nx">Node</span>
		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="nx">x</span> <span class="p">=</span> <span class="nx">l</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
			<span class="nx">y</span> <span class="p">=</span> <span class="nx">l</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
			<span class="k">switch</span> <span class="p">{</span>
			<span class="k">case</span> <span class="nx">x</span><span class="p">.</span><span class="nx">Level</span> <span class="p">&lt;</span> <span class="nx">y</span><span class="p">.</span><span class="nx">Level</span><span class="p">:</span>
				<span class="nx">addchild</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span>
			<span class="k">case</span> <span class="nx">x</span><span class="p">.</span><span class="nx">Level</span> <span class="p">&gt;</span> <span class="nx">y</span><span class="p">.</span><span class="nx">Level</span><span class="p">:</span>
				<span class="nx">addchild</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span>
			<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-26">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
                <p>if x.Level == y.Level
and x y are consective in Euler Tour
thus x == y</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">gn</span> <span class="p">=</span> <span class="k">range</span> <span class="nx">gl</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">gn</span><span class="p">.</span><span class="nx">IsBinary</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">gn</span><span class="p">.</span><span class="nx">IsLeaf</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">{</span>
				<span class="nx">n</span><span class="p">.</span><span class="nx">Father</span> <span class="p">=</span> <span class="kc">nil</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-27">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
                <p>print(n.Name, &ldquo; &ldquo;)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>			<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-28">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
                <p>println()</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>			<span class="nx">reconstruct</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-29">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
                <p>fmt.Println(&rdquo;: &ldquo;, a[i][0])</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>			<span class="nx">refine</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-30">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
                <p>minDupPlusLoss(a[i][0])</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>			<span class="nx">gn</span><span class="p">.</span><span class="nx">replaceBy</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-31">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
                <p>some clean up</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">gt</span><span class="p">.</span><span class="nx">Update</span><span class="p">()</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">gt</span><span class="p">.</span><span class="nx">Nodes</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-32">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
                <p>remove node with out-degree 1.
just by replace node with its single children</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
			<span class="nx">n</span><span class="p">.</span><span class="nx">replaceBy</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">!</span><span class="nx">n</span><span class="p">.</span><span class="nx">IsLeaf</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">n</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="s">&quot;&quot;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">gt</span><span class="p">.</span><span class="nx">Update</span><span class="p">()</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-33">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
                <p>println(&ldquo;Step 5 done.&rdquo;)
fmt.Println(gt)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="k">return</span> <span class="nx">a</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">minDupThenLoss</span><span class="p">(</span><span class="nx">root</span> <span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">nl</span> <span class="o">:=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">Post2List</span><span class="p">()</span>
	<span class="nx">size</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">nl</span><span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-34">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
                <p>A[i] = W[i] - 1 for leaf, otherwise
A[i] is the min of B[lchild], B[rchild]</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">A</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-35">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
                <p>B[i] = W[i] - 1 for leaf, otherwise
B[i] is the max of B[lchild], B[rchild]</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">B</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
	<span class="nx">W</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
	<span class="nx">P</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([][]</span><span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nl</span> <span class="p">{</span>
		<span class="nx">n</span><span class="p">.</span><span class="nx">Id</span> <span class="p">=</span> <span class="nx">i</span>
		<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Ext</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">P</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Ext</span><span class="p">.([]</span><span class="o">*</span><span class="nx">Node</span><span class="p">)</span>
			<span class="nx">n</span><span class="p">.</span><span class="nx">Ext</span> <span class="p">=</span> <span class="kc">nil</span>
		<span class="p">}</span>
		<span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">P</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
        <span class="nx">nchild</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">)</span>
        <span class="k">switch</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">nchild</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nx">A</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="nx">B</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">case</span> <span class="nx">nchild</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nx">A</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span>
            <span class="nx">B</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="nx">B</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Id</span><span class="p">]</span>
        <span class="k">case</span> <span class="nx">nchild</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
			<span class="nx">b1</span> <span class="o">:=</span> <span class="nx">B</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Id</span><span class="p">]</span>
			<span class="nx">b2</span> <span class="o">:=</span> <span class="nx">B</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">Id</span><span class="p">]</span>
			<span class="k">if</span> <span class="nx">b1</span> <span class="p">&gt;</span> <span class="nx">b2</span> <span class="p">{</span>
				<span class="nx">A</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">b2</span>
				<span class="nx">B</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">b1</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">A</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">b1</span>
				<span class="nx">B</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">b2</span>
			<span class="p">}</span>
			<span class="nx">A</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
			<span class="nx">B</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">default</span><span class="p">:</span>
			<span class="nb">panic</span><span class="p">(</span><span class="s">&quot;Incorrect number of children.&quot;</span><span class="p">)</span>
        <span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">Fid</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">nl</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Father</span><span class="p">.</span><span class="nx">Id</span>
	<span class="p">}</span>

	<span class="nx">getk</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">t</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">t</span> <span class="o">&gt;=</span> <span class="nx">b</span><span class="p">:</span>
			<span class="k">return</span> <span class="nx">b</span>
		<span class="k">case</span> <span class="nx">t</span> <span class="o">&lt;=</span> <span class="nx">a</span><span class="p">:</span>
			<span class="k">return</span> <span class="nx">a</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="k">return</span> <span class="nx">t</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">T</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
	<span class="nx">K</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
	<span class="nx">T</span><span class="p">[</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="mi">0</span>
	<span class="nx">K</span><span class="p">[</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="nx">getk</span><span class="p">(</span><span class="nx">A</span><span class="p">[</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nx">B</span><span class="p">[</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
		<span class="nx">n</span> <span class="o">:=</span> <span class="nx">nl</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
		<span class="nx">T</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">K</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Father</span><span class="p">.</span><span class="nx">Id</span><span class="p">]</span> <span class="o">-</span> <span class="nx">W</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Father</span><span class="p">.</span><span class="nx">Id</span><span class="p">]</span>
		<span class="nx">K</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">getk</span><span class="p">(</span><span class="nx">A</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">B</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">T</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
	<span class="p">}</span>

	<span class="nx">simpleConstruct</span><span class="p">(</span><span class="nx">nl</span><span class="p">,</span> <span class="nx">K</span><span class="p">,</span> <span class="nx">T</span><span class="p">,</span> <span class="nx">W</span><span class="p">,</span> <span class="nx">Fid</span><span class="p">,</span> <span class="nx">P</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">minLossThenDup</span><span class="p">(</span><span class="nx">root</span> <span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">nl</span> <span class="o">:=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">Post2List</span><span class="p">()</span>
	<span class="nx">size</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">nl</span><span class="p">)</span>
	<span class="nx">K</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
	<span class="nx">W</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
	<span class="nx">P</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([][]</span><span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nl</span> <span class="p">{</span>
		<span class="nx">n</span><span class="p">.</span><span class="nx">Id</span> <span class="p">=</span> <span class="nx">i</span>
		<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Ext</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">P</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Ext</span><span class="p">.([]</span><span class="o">*</span><span class="nx">Node</span><span class="p">)</span>
			<span class="nx">n</span><span class="p">.</span><span class="nx">Ext</span> <span class="p">=</span> <span class="kc">nil</span>
		<span class="p">}</span>
		<span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">P</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
        <span class="nx">nchild</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">)</span>
        <span class="k">switch</span> <span class="nx">nchild</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nx">K</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nx">K</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-36">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
                <p>if n.Children[0].Level - n.Level == 1 {
K[i] += K[n.Children[0].Id]
}</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>        <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
			<span class="kd">var</span> <span class="nx">v1</span><span class="p">,</span> <span class="nx">v2</span> <span class="kt">int</span>
			<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Level</span><span class="o">-</span><span class="nx">n</span><span class="p">.</span><span class="nx">Level</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
				<span class="nx">v1</span> <span class="p">=</span> <span class="nx">K</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Id</span><span class="p">]</span>
			<span class="p">}</span> <span class="c1">// else v1 = 0</span>
			<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">Level</span><span class="o">-</span><span class="nx">n</span><span class="p">.</span><span class="nx">Level</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
				<span class="nx">v2</span> <span class="p">=</span> <span class="nx">K</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">Id</span><span class="p">]</span>
			<span class="p">}</span> <span class="c1">// else v2 = 0</span>
			<span class="k">if</span> <span class="nx">v1</span> <span class="p">&gt;</span> <span class="nx">v2</span> <span class="p">{</span>
				<span class="nx">K</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v2</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">K</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v1</span>
			<span class="p">}</span>
			<span class="nx">K</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">Fid</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">nl</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Father</span><span class="p">.</span><span class="nx">Id</span>
	<span class="p">}</span>

	<span class="nx">T</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
	<span class="nx">T</span><span class="p">[</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
		<span class="nx">n</span> <span class="o">:=</span> <span class="nx">nl</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
		<span class="nx">T</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">K</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Father</span><span class="p">.</span><span class="nx">Id</span><span class="p">]</span> <span class="o">-</span> <span class="nx">W</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Father</span><span class="p">.</span><span class="nx">Id</span><span class="p">]</span>
	<span class="p">}</span>

	<span class="nx">simpleConstruct</span><span class="p">(</span><span class="nx">nl</span><span class="p">,</span> <span class="nx">K</span><span class="p">,</span> <span class="nx">T</span><span class="p">,</span> <span class="nx">W</span><span class="p">,</span> <span class="nx">Fid</span><span class="p">,</span> <span class="nx">P</span><span class="p">)</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-37">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
                <p>Refine gene tree node to achieve minimal duplication + loss cost</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">func</span> <span class="nx">minDupPlusLoss</span><span class="p">(</span><span class="nx">root</span> <span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-38">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
                <p>bottom up, update a, b on each edge with length d
i.e. d = node.Level - father.Level</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">update</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">d</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">d</span> <span class="p">&gt;</span> <span class="mi">2</span><span class="p">:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
		<span class="k">case</span> <span class="nx">d</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">a</span>
		<span class="k">case</span> <span class="nx">d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">return</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="nb">panic</span><span class="p">(</span><span class="s">&quot;Incorrect level difference.&quot;</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-39">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
                <p>bottom up, get a, b from w, a1, b1, a2, b2</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>    <span class="nx">getab</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sort</span><span class="p">.</span><span class="nx">Ints</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">w</span><span class="o">+</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">w</span><span class="o">+</span><span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-40">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
                <p>top down, get k from t, a, b</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">getk</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">t</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">t</span> <span class="o">&gt;=</span> <span class="nx">b</span><span class="p">:</span>
			<span class="k">return</span> <span class="nx">b</span>
		<span class="k">case</span> <span class="nx">t</span> <span class="o">&lt;=</span> <span class="nx">a</span><span class="p">:</span>
			<span class="k">return</span> <span class="nx">a</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="k">return</span> <span class="nx">t</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-41">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
                <p>don&rsquo;t update level!
keep the level value from original species tree!</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">nl</span> <span class="o">:=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">Post2List</span><span class="p">()</span>
	<span class="nx">size</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">nl</span><span class="p">)</span>
	<span class="nx">A</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
	<span class="nx">B</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
	<span class="nx">W</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-42">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
                <p>use P[i] to denote the preimages of node i,
which are stored in node.Ext</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">P</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([][]</span><span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-43">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
                <p>Not necessary, so remove it since Go&rsquo;s GC is slow.
level difference, i.e. node.Level-father.Level
d := make([]int, size)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">a1</span><span class="p">,</span> <span class="nx">b1</span><span class="p">,</span> <span class="nx">a2</span><span class="p">,</span> <span class="nx">b2</span><span class="p">,</span> <span class="nx">d1</span><span class="p">,</span> <span class="nx">d2</span> <span class="kt">int</span>
    <span class="kd">var</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">father</span><span class="p">,</span> <span class="nx">lchild</span><span class="p">,</span> <span class="nx">rchild</span> <span class="o">*</span><span class="nx">Node</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">t</span> <span class="kt">int</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-44">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
                <p>Now calculate a, b, and w for each node.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">node</span> <span class="p">=</span> <span class="k">range</span> <span class="nx">nl</span> <span class="p">{</span>
		<span class="nx">node</span><span class="p">.</span><span class="nx">Id</span> <span class="p">=</span> <span class="nx">i</span>
		<span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Ext</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">P</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Ext</span><span class="p">.([]</span><span class="o">*</span><span class="nx">Node</span><span class="p">)</span>
			<span class="nx">node</span><span class="p">.</span><span class="nx">Ext</span> <span class="p">=</span> <span class="kc">nil</span>
		<span class="p">}</span> <span class="c1">// else {</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-45">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
                <pre><code>P[i] = nil
</code></pre>

<p>}</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">P</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
		<span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">IsLeaf</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">A</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1">// remove background tree</span>
			<span class="nx">B</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">A</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-46">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
                <p>nchild = len(node.Children)
var a1,b1,a2,b2,d1,d2 int
var lchild, rchild *Node
switch len(node.Children){
//case nchild &gt; 2 || nchild == 0:
////fmt.Println(node)
//panic(&ldquo;Incorrect number of children.&rdquo;)
case 2:
rchild := node.Children[1]
a2, b2 := A[rchild.Id], B[rchild.Id]
d2 := rchild.Level - node.Level
a2, b2 = update(a2, b2, d2)
case 1:
a2, b2 := 0, 0
}</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">Children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">{</span>
                <span class="nx">rchild</span> <span class="p">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="nx">a2</span><span class="p">,</span> <span class="nx">b2</span> <span class="p">=</span> <span class="nx">A</span><span class="p">[</span><span class="nx">rchild</span><span class="p">.</span><span class="nx">Id</span><span class="p">],</span> <span class="nx">B</span><span class="p">[</span><span class="nx">rchild</span><span class="p">.</span><span class="nx">Id</span><span class="p">]</span>
                <span class="nx">d2</span> <span class="p">=</span> <span class="nx">rchild</span><span class="p">.</span><span class="nx">Level</span> <span class="o">-</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Level</span>
				<span class="nx">a2</span><span class="p">,</span> <span class="nx">b2</span> <span class="p">=</span> <span class="nx">update</span><span class="p">(</span><span class="nx">a2</span><span class="p">,</span> <span class="nx">b2</span><span class="p">,</span> <span class="nx">d2</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">a2</span><span class="p">,</span> <span class="nx">b2</span> <span class="p">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="p">}</span>
             

            <span class="nx">lchild</span> <span class="p">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nx">a1</span><span class="p">,</span><span class="nx">b1</span> <span class="p">=</span> <span class="nx">A</span><span class="p">[</span><span class="nx">lchild</span><span class="p">.</span><span class="nx">Id</span><span class="p">],</span>  <span class="nx">B</span><span class="p">[</span><span class="nx">lchild</span><span class="p">.</span><span class="nx">Id</span><span class="p">]</span>
            <span class="nx">d1</span> <span class="p">=</span> <span class="nx">lchild</span><span class="p">.</span><span class="nx">Level</span> <span class="o">-</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Level</span>
			<span class="nx">a1</span><span class="p">,</span> <span class="nx">b1</span> <span class="p">=</span> <span class="nx">update</span><span class="p">(</span><span class="nx">a1</span><span class="p">,</span> <span class="nx">b1</span><span class="p">,</span> <span class="nx">d1</span><span class="p">)</span>

			<span class="nx">A</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">B</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">getab</span><span class="p">(</span><span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">a1</span><span class="p">,</span> <span class="nx">b1</span><span class="p">,</span> <span class="nx">a2</span><span class="p">,</span> <span class="nx">b2</span><span class="p">)</span>
		<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-47">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
                <p>fmt.Println(A[i], B[i], W[i], a1, b1, d1, a2, b2, d2, node.Name)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-48">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
                <p>K[i]: the number of gene lineages entering the
incoming edge of node[i].</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">K</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-49">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
                <p>T[i]: the number of gene lineages leaving the
incoming branch of node[i], and entering node[i].
i.e. the number of gene copies that node[i] inherited.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">T</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-50">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
                <p>use Fid[i] to store the nl[i].Father.Id,
as nl[i].Father will change later.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">Fid</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-51">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
                <p>There is no extra lineage at root, thus t = 0</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">T</span><span class="p">[</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="mi">0</span>
	<span class="nx">K</span><span class="p">[</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="nx">getk</span><span class="p">(</span><span class="nx">A</span><span class="p">[</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nx">B</span><span class="p">[</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-52">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
                <p>the number of incoming extra lineages at node</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span> <span class="p">=</span> <span class="nx">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
        <span class="nx">node</span> <span class="p">=</span> <span class="nx">nl</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="nx">father</span> <span class="p">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Father</span>
		<span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">father</span><span class="p">.</span><span class="nx">Id</span>
        <span class="nx">t</span> <span class="p">=</span> <span class="nx">K</span><span class="p">[</span><span class="nx">father</span><span class="p">.</span><span class="nx">Id</span><span class="p">]</span> <span class="o">-</span> <span class="nx">W</span><span class="p">[</span><span class="nx">father</span><span class="p">.</span><span class="nx">Id</span><span class="p">]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-53">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
                <p>if level difference &gt; 2, it&rsquo;s fine to
loss all extra lineages</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Level</span><span class="o">-</span><span class="nx">father</span><span class="p">.</span><span class="nx">Level</span> <span class="p">&gt;</span> <span class="mi">2</span> <span class="p">{</span>
			<span class="nx">t</span> <span class="p">=</span> <span class="mi">0</span>
		<span class="p">}</span>
		<span class="nx">T</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">t</span>
		<span class="nx">K</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">getk</span><span class="p">(</span><span class="nx">A</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">B</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">t</span><span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-54">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
                <p>println(i, node.Name, K[i])</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="p">}</span>
	<span class="nx">simpleConstruct</span><span class="p">(</span><span class="nx">nl</span><span class="p">,</span> <span class="nx">K</span><span class="p">,</span> <span class="nx">T</span><span class="p">,</span> <span class="nx">W</span><span class="p">,</span> <span class="nx">Fid</span><span class="p">,</span> <span class="nx">P</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">weightedCost</span><span class="p">(</span><span class="nx">wdup</span><span class="p">,</span> <span class="nx">wdc</span> <span class="kt">float64</span><span class="p">)</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">root</span> <span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">nl</span> <span class="o">:=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">Post2List</span><span class="p">()</span>
		<span class="nx">size</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">nl</span><span class="p">)</span>
		<span class="nx">M</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
		<span class="nx">W</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
		<span class="nx">P</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([][]</span><span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-55">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
                <p>C := make([][]float64, size)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="nx">U</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([][]</span><span class="kt">float64</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
		<span class="nx">I</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([][]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
		<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nl</span> <span class="p">{</span>
			<span class="nx">n</span><span class="p">.</span><span class="nx">Id</span> <span class="p">=</span> <span class="nx">i</span>
			<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Ext</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">P</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Ext</span><span class="p">.([]</span><span class="o">*</span><span class="nx">Node</span><span class="p">)</span>
				<span class="nx">n</span><span class="p">.</span><span class="nx">Ext</span> <span class="p">=</span> <span class="kc">nil</span>
			<span class="p">}</span>
			<span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">P</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
			<span class="k">switch</span> <span class="p">{</span>
			<span class="k">case</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="nx">M</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
			<span class="k">case</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="nx">M</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">M</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Id</span><span class="p">]</span> <span class="o">+</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
			<span class="k">case</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
				<span class="nx">v1</span> <span class="o">:=</span> <span class="nx">M</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Id</span><span class="p">]</span>
				<span class="nx">v2</span> <span class="o">:=</span> <span class="nx">M</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">Id</span><span class="p">]</span>
				<span class="k">if</span> <span class="nx">v1</span> <span class="p">&gt;</span> <span class="nx">v2</span> <span class="p">{</span>
					<span class="nx">M</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v1</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="nx">M</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v2</span>
				<span class="p">}</span>
				<span class="nx">M</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-56">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
                <p>A special case is that there is
only one node in I^*(g).</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
			<span class="nx">K</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
			<span class="nx">T</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
			<span class="nx">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="mi">0</span>
			<span class="nx">K</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="nx">W</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
			<span class="nx">simpleConstruct</span><span class="p">(</span><span class="nx">nl</span><span class="p">,</span> <span class="nx">K</span><span class="p">,</span> <span class="nx">T</span><span class="p">,</span> <span class="nx">W</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">P</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="p">}</span>

		<span class="nx">mul</span> <span class="o">:=</span> <span class="nx">M</span><span class="p">[</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="nx">C</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">float64</span><span class="p">,</span> <span class="nx">mul</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

		<span class="nx">min</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">args</span> <span class="o">...</span><span class="kt">float64</span><span class="p">)</span> <span class="kt">float64</span> <span class="p">{</span>
			<span class="nx">m</span> <span class="o">:=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">&lt;</span> <span class="nx">m</span> <span class="p">{</span>
					<span class="nx">m</span> <span class="p">=</span> <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="nx">m</span>
		<span class="p">}</span>

		<span class="nx">getCost</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">in</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">d</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">float64</span> <span class="p">{</span>
			<span class="nx">m</span> <span class="o">:=</span> <span class="nx">min</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span><span class="o">*</span><span class="nx">wdc</span><span class="p">,</span> <span class="nx">wdup</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">in</span> <span class="o">&gt;=</span> <span class="nx">out</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">m</span> <span class="o">*</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">m</span><span class="o">*</span><span class="nb">float64</span><span class="p">(</span><span class="nx">in</span><span class="p">)</span> <span class="o">+</span> <span class="nx">wdup</span><span class="o">*</span><span class="nb">float64</span><span class="p">(</span><span class="nx">out</span><span class="o">-</span><span class="nx">in</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="nx">getMin</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ind</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">d</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">w</span> <span class="o">:=</span> <span class="nx">W</span><span class="p">[</span><span class="nx">ind</span><span class="p">]</span> <span class="c1">// multiplicity</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-57">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
                <p>l := C[ind] // list of cost</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>            <span class="nx">l</span> <span class="o">:=</span> <span class="nx">C</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-58">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
                <p>(p, m): the cost m with p outgoing lineages
in branch ind with in incoming lineages.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>			<span class="nx">p</span><span class="p">,</span> <span class="nx">m</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">getCost</span><span class="p">(</span><span class="nx">in</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span><span class="o">+</span><span class="nx">l</span><span class="p">[</span><span class="nx">w</span><span class="p">]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-59">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
                <p>println(nl[ind].Name, int(m), in, p, int(l[w]))
for out := w + 1; out &lt;= mul; out++ {</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>            <span class="k">for</span> <span class="nx">out</span> <span class="o">:=</span> <span class="nx">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">out</span> <span class="o">&lt;=</span> <span class="nx">M</span><span class="p">[</span><span class="nx">ind</span><span class="p">];</span> <span class="nx">out</span><span class="o">++</span> <span class="p">{</span>
				<span class="nx">t</span> <span class="o">:=</span> <span class="nx">getCost</span><span class="p">(</span><span class="nx">in</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="o">+</span> <span class="nx">l</span><span class="p">[</span><span class="nx">out</span><span class="p">]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-60">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
                <p>println(nl[ind].Name, int(t), in, out, int(l[out]))</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>				<span class="k">if</span> <span class="nx">t</span> <span class="p">&lt;</span> <span class="nx">m</span> <span class="p">{</span>
					<span class="nx">p</span><span class="p">,</span> <span class="nx">m</span> <span class="p">=</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">t</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="nx">U</span><span class="p">[</span><span class="nx">ind</span><span class="p">][</span><span class="nx">in</span><span class="p">]</span> <span class="p">=</span> <span class="nx">m</span>
			<span class="nx">I</span><span class="p">[</span><span class="nx">ind</span><span class="p">][</span><span class="nx">in</span><span class="p">]</span> <span class="p">=</span> <span class="nx">p</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-61">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
                <p>println(&ldquo;-&gt;&rdquo;, nl[ind].Name, int(m), in, p)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="p">}</span>

		<span class="nx">getC</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">w</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">n</span> <span class="o">:=</span> <span class="nx">nl</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
			<span class="k">switch</span> <span class="p">{</span>
			<span class="k">case</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="nx">lu</span> <span class="o">:=</span> <span class="nx">U</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Id</span><span class="p">]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-62">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
                <p>for j := w; j &lt;= mul; j++ {</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>				<span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;=</span> <span class="nx">M</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-63">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
                <p>C[i][j] = lu[j-w]</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>                    <span class="nx">C</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">lu</span><span class="p">[</span><span class="nx">j</span><span class="o">-</span><span class="nx">w</span><span class="p">]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-64">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
                <p>println(&ldquo;C&rdquo;, n.Name, j, int(C[i][j]))</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>				<span class="p">}</span>
			<span class="k">case</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
				<span class="nx">lu</span> <span class="o">:=</span> <span class="nx">U</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Id</span><span class="p">]</span>
				<span class="nx">ru</span> <span class="o">:=</span> <span class="nx">U</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">Id</span><span class="p">]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-65">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
                <p>for j := w; j &lt;= mul; j++ {</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>				<span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;=</span> <span class="nx">M</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-66">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
                <p>C[i][j] = lu[j-w] + ru[j-w]</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>                    <span class="nx">C</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">lu</span><span class="p">[</span><span class="nx">j</span><span class="o">-</span><span class="nx">w</span><span class="p">]</span> <span class="o">+</span> <span class="nx">ru</span><span class="p">[</span><span class="nx">j</span><span class="o">-</span><span class="nx">w</span><span class="p">]</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="nx">Fid</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">nl</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Father</span><span class="p">.</span><span class="nx">Id</span>
		<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-67">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
                <p>println(&ldquo;&ndash;&rdquo;)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nl</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-68">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
                <p>C[i] = make([]float64, mul+1)
U[i] = make([]float64, mul+1)
I[i] = make([]int, mul+1)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>			<span class="nx">w</span> <span class="o">:=</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-69">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
                <p>println(n.Name, w)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>			<span class="k">switch</span> <span class="p">{</span>
			<span class="k">case</span> <span class="nx">n</span><span class="p">.</span><span class="nx">IsLeaf</span><span class="p">():</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-70">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
                <p>U[i] = U[i][0:M[Fid[i]]- W[Fid[i]]+1]
I[i] = I[i][0:M[Fid[i]]- W[Fid[i]]+1]</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>                <span class="nx">U</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">float64</span><span class="p">,</span><span class="nx">M</span><span class="p">[</span><span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span><span class="o">-</span> <span class="nx">W</span><span class="p">[</span><span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="nx">I</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span><span class="nx">M</span><span class="p">[</span><span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span><span class="o">-</span> <span class="nx">W</span><span class="p">[</span><span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
				<span class="nx">d</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Level</span> <span class="o">-</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Father</span><span class="p">.</span><span class="nx">Level</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-71">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
                <p>for j := 0; j &lt;= mul; j++ {
for j := 0; j &lt;= N[i]; j++ {</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>                <span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;=</span> <span class="nx">M</span><span class="p">[</span><span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">-</span> <span class="nx">W</span><span class="p">[</span><span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
					<span class="nx">U</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">getCost</span><span class="p">(</span><span class="nx">j</span><span class="p">,</span> <span class="nx">w</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span>
					<span class="nx">I</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">w</span> <span class="o">-</span> <span class="mi">1</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="nx">n</span><span class="p">.</span><span class="nx">IsRoot</span><span class="p">():</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-72">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
                <p>U[i] = U[i][0:1]
I[i] = I[i][0:1]</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>                <span class="nx">U</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">float64</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="nx">I</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
				<span class="nx">getC</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">w</span><span class="p">)</span>
				<span class="nx">getMin</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">default</span><span class="p">:</span> <span class="c1">// internal not root</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-73">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
                <p>U[i] = U[i][0:M[Fid[i]]- W[Fid[i]]+1]
I[i] = I[i][0:M[Fid[i]]- W[Fid[i]]+1]</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>                <span class="nx">U</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">float64</span><span class="p">,</span><span class="nx">M</span><span class="p">[</span><span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span><span class="o">-</span> <span class="nx">W</span><span class="p">[</span><span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="nx">I</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span><span class="nx">M</span><span class="p">[</span><span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span><span class="o">-</span> <span class="nx">W</span><span class="p">[</span><span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
				<span class="nx">getC</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">w</span><span class="p">)</span>
				<span class="nx">d</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Level</span> <span class="o">-</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Father</span><span class="p">.</span><span class="nx">Level</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-74">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
                <p>for j := 0; j &lt;= mul; j++ {
for j := 0; j &lt;= N[i]; j++ {</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>                <span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;=</span> <span class="nx">M</span><span class="p">[</span><span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">-</span> <span class="nx">W</span><span class="p">[</span><span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
					<span class="nx">getMin</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="nx">K</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
		<span class="nx">T</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
		<span class="nx">T</span><span class="p">[</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="mi">0</span>
		<span class="nx">K</span><span class="p">[</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="nx">I</span><span class="p">[</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-75">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
                <p>println(&ldquo;size: &ldquo;, size)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
			<span class="nx">n</span> <span class="o">:=</span> <span class="nx">nl</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
			<span class="nx">T</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">K</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Father</span><span class="p">.</span><span class="nx">Id</span><span class="p">]</span> <span class="o">-</span> <span class="nx">W</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">Father</span><span class="p">.</span><span class="nx">Id</span><span class="p">]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-76">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
                <p>println(T[i])
println(i, T[i], len(I[i]), n.IsLeaf())</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>			<span class="nx">K</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">I</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">T</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-77">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
                <p>Important!</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>            <span class="nx">d</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Level</span> <span class="o">-</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Father</span><span class="p">.</span><span class="nx">Level</span>
            <span class="k">if</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span><span class="o">*</span><span class="nx">wdc</span> <span class="p">&gt;</span> <span class="nx">wdup</span> <span class="p">{</span>
                <span class="nx">T</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="mi">0</span>
            <span class="p">}</span>
		<span class="p">}</span>

		<span class="nx">simpleConstruct</span><span class="p">(</span><span class="nx">nl</span><span class="p">,</span> <span class="nx">K</span><span class="p">,</span> <span class="nx">T</span><span class="p">,</span> <span class="nx">W</span><span class="p">,</span> <span class="nx">Fid</span><span class="p">,</span> <span class="nx">P</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-78">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
                <p>A simple reconstruction of subtree with
the information on I^*(g).
All duplication occurs on the background tree.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="kd">func</span> <span class="nx">simpleConstruct</span><span class="p">(</span><span class="nx">nl</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">K</span><span class="p">,</span> <span class="nx">T</span><span class="p">,</span> <span class="nx">W</span><span class="p">,</span> <span class="nx">Fid</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">P</span> <span class="p">[][]</span><span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-79">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
                <p>insert nodes onto the edge (node.Father, node)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">insertNode</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">node</span> <span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">nodes</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="nx">lchild</span> <span class="o">:=</span> <span class="nx">newNode</span><span class="p">()</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-80">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
                <p>replaceNode(lchild, node)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="nx">lchild</span><span class="p">.</span><span class="nx">replaceBy</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
		<span class="nx">node</span><span class="p">.</span><span class="nx">Children</span> <span class="p">=</span> <span class="kc">nil</span>
		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">nodes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="nx">nnode</span> <span class="o">:=</span> <span class="nx">newNode</span><span class="p">()</span>
			<span class="nx">nnode</span><span class="p">.</span><span class="nx">AddChild</span><span class="p">(</span><span class="nx">lchild</span><span class="p">)</span>
			<span class="nx">nnode</span><span class="p">.</span><span class="nx">AddChild</span><span class="p">(</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
			<span class="nx">lchild</span> <span class="p">=</span> <span class="nx">nnode</span>
		<span class="p">}</span>
		<span class="nx">node</span><span class="p">.</span><span class="nx">AddChild</span><span class="p">(</span><span class="nx">lchild</span><span class="p">)</span>
		<span class="nx">node</span><span class="p">.</span><span class="nx">AddChild</span><span class="p">(</span><span class="nx">nodes</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">nodes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
	<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-81">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
                <p>every node = nl[i] in the tree I^*(g)
may has multiple extra copies,
we store them in the list nodes[i].</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="nx">nodes</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([][]</span><span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">K</span><span class="p">))</span>

	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">K</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-82">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
                <p>K[i] extra copies.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">K</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
		<span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">{</span>
			<span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">newNode</span><span class="p">()</span>
		<span class="p">}</span>

		<span class="nx">node</span> <span class="o">:=</span> <span class="nx">nl</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-83">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
                <p>we need to replace the leaves with original
children of non-binary gene tree node,
such that we can embed the refined tree into
the original gene tree.</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">IsLeaf</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">K</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
				<span class="nb">panic</span><span class="p">(</span><span class="s">&quot;Something wrong.&quot;</span><span class="p">)</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">!</span><span class="nx">node</span><span class="p">.</span><span class="nx">IsLeaf</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">K</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">&lt;</span> <span class="nx">W</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">{</span>
				<span class="nb">panic</span><span class="p">(</span><span class="s">&quot;Something wrong too.&quot;</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">IsLeaf</span><span class="p">()</span> <span class="p">{</span>
				<span class="k">for</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">{</span>
					<span class="nx">n</span><span class="p">.</span><span class="nx">replaceBy</span><span class="p">(</span><span class="nx">P</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
				<span class="p">}</span>
				<span class="nx">node</span><span class="p">.</span><span class="nx">replaceBy</span><span class="p">(</span><span class="nx">P</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">for</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">pnode</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">P</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">{</span>
					<span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">K</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nx">j</span><span class="p">].</span><span class="nx">replaceBy</span><span class="p">(</span><span class="nx">pnode</span><span class="p">)</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Father</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">fid</span> <span class="o">:=</span> <span class="nx">Fid</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-84">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
                <p>connect extra nodes at n to the nodes
at n.Father as much as possible</p>

            </td>
            <td class="code">
                <div class="highlight"><pre></pre></div>
            </td>
          </tr>
          
          <tr id="section-85">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
                <p>extra := nodes[fid][0 : K[fid]-W[fid]]</p>

            </td>
            <td class="code">
                <div class="highlight"><pre></pre></div>
            </td>
          </tr>
          
          <tr id="section-86">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
                <p>there are T[i] lineages inherited from n.father
extra := nodes[fid][0:T[i]]
length = len(extra)
fmt.Println(length, K[i])
for j:=0; j&lt;length &amp;&amp; j&lt;K[i]; j++{
for j, n := range nodes[fid][0:T[i]] {</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>			<span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="nx">T</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="nx">K</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
				<span class="nx">nodes</span><span class="p">[</span><span class="nx">fid</span><span class="p">][</span><span class="nx">j</span><span class="p">].</span><span class="nx">AddChild</span><span class="p">(</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">])</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-87">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
                <p>the rest nodes are just duplicated from background tree.
i.e. from the node = nl[i].</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">T</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">&lt;</span> <span class="nx">K</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">{</span>
			<span class="nx">insertNode</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">T</span><span class="p">[</span><span class="nx">i</span><span class="p">]:</span><span class="nx">K</span><span class="p">[</span><span class="nx">i</span><span class="p">]])</span>
		<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-88">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
                <p>fmt.Println(&ldquo;out &ldquo;, root)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nl</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-89">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
                <p>replaceNode(n, n.Children[0])</p>

            </td>
            <td class="code">
                <div class="highlight"><pre>			<span class="nx">n</span><span class="p">.</span><span class="nx">replaceBy</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">Children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div>
            </td>
          </tr>
          
          <tr id="section-90">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
                <p>This step has been moved to the caller function!</p>

            </td>
            <td class="code">
                <div class="highlight"><pre></pre></div>
            </td>
          </tr>
          
          <tr id="section-91">
            <td class="docs">
              <div class="pilwrap">
                  <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
                <p>// now replace the original non-binary tree node with root of I^*(g)
replaceNode(root.Map, root)</p>

            </td>
            <td class="code">
                <div class="highlight"><pre><span class="p">}</span>

</pre></div>
            </td>
          </tr>
          
      </tbody>
    </table>
  </div>
</body>
</html>
